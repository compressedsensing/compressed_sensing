#include "contiki.h"
#include "fixedpoint.h"
#include "./randomGenerator.h"
#include "./linalg.h"
#include "./ec_scheme.h"
#include <stdio.h>
#include "net/routing/routing.h"
#include "net/netstack.h"
#include "net/ipv6/simple-udp.h"

// #include "cc2420.h"

#define UDP_CLIENT_PORT 8765
#define UDP_SERVER_PORT 5678
#define SEND_INTERVAL (10 * CLOCK_SECOND)

static struct simple_udp_connection udp_conn;
static struct ctimer timer;

static uint8_t signal_bytes[M * 2] = {0};
static uip_ipaddr_t dest_ipaddr = {{0xfe, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x12, 0x74, 0x00, 0x1a, 0x45, 0xa3, 0x30}};


static int16_t signal[SIGNAL_LEN] = {  0, 995, 995, 995, 995, 995, 995, 995,1000, 997, 995, 994, 992, 993,
  992, 989, 988, 987, 990, 993, 989, 988, 986, 988, 993, 997, 993, 986,
  983, 977, 979, 975, 974, 972, 969, 969, 969, 971, 973, 971, 969, 966,
  966, 966, 966, 967, 965, 963, 967, 969, 969, 968, 967, 963, 966, 964,
  968, 966, 964, 961, 960, 957, 952, 947, 947, 943, 933, 927, 927, 939,
  958, 980,1010,1048,1099,1148,1180,1192,1177,1128,1058, 991, 951, 937,
  939, 950, 958, 959, 957, 955, 958, 959, 961, 962, 960, 957, 956, 959,
  955, 957, 958, 957, 958, 959, 958, 958, 955, 953, 957, 959, 963, 960,
  960, 958, 956, 957, 956, 955, 953, 953, 956, 958, 958, 958, 956, 954,
  959, 959, 958, 958, 957, 957, 956, 958, 956, 954, 953, 954, 955, 958,
  960, 957, 958, 955, 958, 957, 957, 955, 955, 953, 956, 956, 957, 958,
  954, 954, 955, 957, 957, 957, 954, 953, 953, 955, 955, 957, 954, 952,
  952, 952, 951, 952, 950, 947, 950, 952, 953, 952, 949, 949, 951, 951,
  952, 952, 951, 950, 953, 958, 959, 959, 957, 956, 961, 964, 964, 966,
  965, 966, 967, 969, 973, 974, 974, 971, 973, 975, 978, 975, 975, 973,
  973, 976, 974, 973, 975, 973, 974, 974, 971, 972, 972, 971, 970, 971,
  972, 969, 968, 966, 969, 970, 972, 968, 968, 967, 969, 969, 971, 970,
  967, 966, 968, 969, 967, 968, 964, 964, 963, 965, 964, 962, 962, 963,
  965, 967, 967, 966, 965, 962, 966, 965, 964, 963, 962, 959, 962, 964,
  966, 962, 959, 958, 961, 964, 963, 962, 960, 958, 959, 961, 962, 963,
  963, 962, 964, 963, 966, 964, 964, 963, 963, 966, 968, 965, 963, 961,
  963, 965, 966, 968, 970, 969, 969, 970, 974, 974, 973, 979, 980, 983,
  984, 983, 981, 978, 980, 979, 979, 979, 978, 977, 976, 977, 980, 982,
  983, 975, 967, 967, 964, 962, 958, 958, 959, 961, 960, 961, 959, 956,
  955, 956, 956, 954, 955, 953, 958, 957, 958, 960, 955, 953, 956, 958,
  959, 958, 954, 951, 952, 948, 939, 935, 929, 922, 917, 923, 941, 964,
  992,1021,1071,1122,1168,1199,1212,1205,1175,1122,1057,1002, 970, 946,
  934, 929, 933, 939, 946, 946, 947, 946, 948, 948, 948, 945, 947, 947,
  947, 949, 945, 942, 942, 944, 945, 946, 943, 945, 947, 949, 946, 946,
  943, 942, 942, 946, 946, 945, 943, 941, 944, 942, 943, 942, 941, 942,
  944, 944, 945, 946, 943, 942, 946, 946, 947, 947, 942, 943, 945, 946,
  949, 946, 945, 942, 944, 946, 946, 947, 943, 941, 941, 944, 945, 943,
  941, 940, 940, 942, 941, 939, 940, 937, 938, 938, 940, 938, 934, 933,
  934, 937, 935, 934, 933, 930, 932, 933, 934, 933, 930, 929, 932, 934,
  935, 936, 937, 936, 942, 945, 950, 951, 952, 951, 956, 959, 961, 960,
  958, 958, 960, 962, 964, 964, 960, 960, 961, 963, 963, 965, 960, 958,
  963, 962, 964, 964, 960, 959, 962, 963 };

static void
callback(void *prt)
{
    EC.ec_transform(signal);
    simple_udp_register(&udp_conn, UDP_CLIENT_PORT, NULL,
                        UDP_SERVER_PORT, NULL);

    int16_t i;
    for (i = 0; i < M * 2; i += 2)
    {
        signal_bytes[i + 0] = (uint8_t)((signal[i >> 1] & 0xFF00) >> 8);
        signal_bytes[i + 1] = (uint8_t)((signal[i >> 1] & 0x00FF) >> 0);
    }
}

PROCESS(comp_sensing, "compressed");
AUTOSTART_PROCESSES(&comp_sensing);

PROCESS_THREAD(comp_sensing, ev, data)
{
    PROCESS_BEGIN();

    /* Turn radio off */
    NETSTACK_RADIO.off();

    /* Draw random numbers (N*M) */

    ctimer_set(&timer, 2 * CLOCK_SECOND, callback, NULL);

    PROCESS_END();
}