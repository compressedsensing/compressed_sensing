
#include "contiki.h"
// #include "net/rime/rime.h"
#include "fixedpoint.h"
#include "./randomGenerator.h"
#include "./linalg.h"
#include "./ec_scheme.h"
// #include <stddef.h>
#include <stdio.h>
#include "net/routing/routing.h"
#include "net/netstack.h"
#include "net/ipv6/simple-udp.h"

// #include "cc2420.h"

#define UDP_CLIENT_PORT 8765
#define UDP_SERVER_PORT 5678
#define SEND_INTERVAL (10 * CLOCK_SECOND)

static struct simple_udp_connection udp_conn;
// static struct ctimer timer;
static Vector_M ret;
static uint8_t signal_bytes[M * 2] = {0};
static uip_ipaddr_t dest_ipaddr = {{0xfe, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x12, 0x74, 0x00, 0x1a, 0x45, 0xa3, 0x30}};

PROCESS(comp_sensing, "compressed");
AUTOSTART_PROCESSES(&comp_sensing);

PROCESS_THREAD(comp_sensing, ev, data)
{
    // PROCESS_EXITHANDLER(unicast_close(&uc);)
    /* Declare variables required */

    static Vector vec = {{939, 939, 940, 942, 943, 942, 940, 942, 943, 944, 943, 942, 944, 943,
                          947, 947, 947, 947, 947, 945, 944, 946, 947, 948, 950, 954, 960, 968,
                          985, 1006, 1035, 1071, 1112, 1153, 1192, 1225, 1239, 1235, 1201, 1145, 1065, 973,
                          877, 795, 739, 720, 737, 771, 814, 858, 890, 913, 930, 938, 941, 942,
                          940, 940, 938, 941, 944, 949, 950, 952, 952, 953, 952, 951, 951, 953,
                          954, 958, 963, 967, 968, 972, 969, 970, 968, 968, 967, 968, 968, 968,
                          970, 970, 969, 968, 967, 967, 966, 966, 964, 966, 965, 968, 969, 970,
                          970, 970, 974, 974, 975, 979, 980, 982, 988, 992, 996, 1000, 1005, 1010,
                          1012, 1012, 1016, 1019, 1020, 1023, 1025, 1027, 1030, 1034, 1035, 1036, 1034, 1032,
                          1028, 1029, 1027, 1029, 1026, 1023, 1022, 1019, 1015, 1009, 1004, 999, 995, 987,
                          984, 979, 976, 973, 971, 968, 966, 963, 959, 958, 954, 950, 947, 946,
                          947, 945, 945, 946, 946, 946, 945, 944, 944, 942, 941, 939, 941, 942,
                          944, 946, 948, 948, 949, 946, 947, 945, 946, 946, 948, 951, 948, 950,
                          952, 951, 954, 951, 949, 949, 950, 949, 951, 951, 952, 951, 950, 950,
                          949, 949, 949, 946, 946, 945, 945, 945, 945, 945, 945, 946, 943, 941,
                          938, 938, 934, 933, 937, 938, 938, 940, 941, 941, 939, 937, 934, 933,
                          932, 933, 932, 934, 935, 933, 935, 934, 933, 931, 934, 934, 935, 934,
                          938, 941, 943, 946, 947, 950, 950, 953, 954, 955, 952, 952, 950, 949,
                          945, 945, 946, 944, 944, 940, 938, 935, 931, 928, 927, 926, 926, 926,
                          925, 922, 917, 917, 914, 914, 915, 913, 919, 921, 923, 926, 925, 925,
                          922, 920, 918, 917, 916, 917, 918, 920, 921, 924, 924, 925, 923, 923,
                          922, 922, 921, 921, 924, 928, 934, 947, 965, 992, 1020, 1063, 1105, 1149,
                          1191, 1225, 1247, 1248, 1224, 1172, 1095, 999, 896, 796, 723, 684, 687, 720,
                          768, 820, 864, 904, 924, 941, 944, 945, 944, 941, 939, 936, 941, 946,
                          948, 953, 954, 957, 958, 959, 961, 966, 966, 970, 976, 978, 983, 987,
                          989, 993, 996, 996, 997, 996, 997, 996, 997, 998, 999, 1001, 1002, 1002,
                          1002, 1002, 1000, 1000, 1002, 1004, 1009, 1011, 1016, 1019, 1022, 1026, 1027, 1029,
                          1030, 1033, 1035, 1040, 1045, 1048, 1051, 1054, 1057, 1056, 1055, 1056, 1058, 1058,
                          1056, 1059, 1060, 1058, 1058, 1061, 1061, 1060, 1060, 1056, 1055, 1052, 1050, 1048,
                          1046, 1041, 1040, 1033, 1032, 1030, 1022, 1014, 1009, 1001, 995, 989, 984, 983,
                          980, 979, 976, 972, 967, 962, 957, 953, 951, 949, 948, 949, 948, 947,
                          947, 946, 947, 943, 941, 942, 940, 941, 942, 940, 941, 944, 946, 944,
                          944, 941, 942, 941, 941, 942, 943, 943, 946, 947, 949, 952, 952, 950,
                          949, 949, 948, 947, 948, 950, 951, 953, 952, 952, 949, 948, 946, 943,
                          941, 939, 940, 939, 941, 941, 939, 937, 936, 931, 931, 928, 931, 931,
                          932, 929, 931, 931, 932, 931, 931, 930, 933, 931, 933, 934, 935, 939,
                          946, 949, 955, 957, 958, 961, 962, 962}};

    PROCESS_BEGIN();

    /* Turn radio off */
    NETSTACK_RADIO.off();

    /* Test code */
    EC.ec_transform(&vec, &ret);

#if DEBUG
    EC.pprint(&ret);
#endif

    /* Transmission code */
    simple_udp_register(&udp_conn, UDP_CLIENT_PORT, NULL,
                        UDP_SERVER_PORT, NULL);

    for (i = 0; i < M * 2; i += 2)
    {
        signal_bytes[i + 0] = (uint8_t)((ret.data[i >> 1] & 0xFF00) >> 8);
        signal_bytes[i + 1] = (uint8_t)((ret.data[i >> 1] & 0x00FF) >> 0);
    }

    NETSTACK_RADIO.on();
    uint8_t buf[128] = {0};
#if DEBUG
    LOG_INFO("Sending to receiver mote\n");
#endif
    for (i = 0; i <= 2 * M / 128; i++)
    {
        memset(buf, 0, 128);
        memcpy(buf, signal_bytes + (i * 128), i == 2 * M / 128 ? 2 * M % 128 : 128);
        simple_udp_sendto(&udp_conn, buf, i == 2 * M / 128 ? 2 * M % 128 : 128, &dest_ipaddr);
    }
    NETSTACK_RADIO.off();

    PROCESS_END();
}